<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Add a New Query</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="introduction.html">Introduction</a></li><li class="chapter-item expanded affix "><li class="part-title">Building</li><li class="chapter-item expanded "><a href="building.html"><strong aria-hidden="true">1.</strong> Compiling Qrates</a></li><li class="chapter-item expanded affix "><li class="part-title">Extractor</li><li class="chapter-item expanded "><a href="extractor_crates_io.html"><strong aria-hidden="true">2.</strong> Extracting Data from Crates Published on crates.io</a></li><li class="chapter-item expanded "><a href="extractor_private.html"><strong aria-hidden="true">3.</strong> Extracting Data from a Private Rust Project</a></li><li class="chapter-item expanded affix "><li class="part-title">Database</li><li class="chapter-item expanded "><a href="creating_database.html"><strong aria-hidden="true">4.</strong> Creating the Database</a></li><li class="chapter-item expanded "><a href="database_structure.html"><strong aria-hidden="true">5.</strong> Database Structure</a></li><li class="chapter-item expanded affix "><li class="part-title">Queries</li><li class="chapter-item expanded "><a href="queries_run_existing.html"><strong aria-hidden="true">6.</strong> Running Existing Queries</a></li><li class="chapter-item expanded "><a href="queries_add_new.html" class="active"><strong aria-hidden="true">7.</strong> Add a New Query</a></li><li class="chapter-item expanded affix "><li class="part-title">Analysis</li><li class="chapter-item expanded "><a href="analysis_jupyter.html"><strong aria-hidden="true">8.</strong> Analysing Query Results with Jupyter</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#add-a-new-query" id="add-a-new-query">Add a New Query</a></h1>
<p>This chapter shows how to define your own query. Adding a new query typically involves the following steps:</p>
<ol>
<li>Checking the database and determining what information needs to be loaded.</li>
<li>Implementing the function that takes the information and computes the desired result.</li>
<li>Writing the result into a CSV file.</li>
<li>Registering the query in the queries list.</li>
</ol>
<p>Each of the following sections discuss each step in more detail. As an example, we use a query that finds the definitions of types that have raw pointers as fields and are not annotated as <code>#[repr(C)]</code> (<code>manager/src/queries/non_tree_types.rs</code>).</p>
<h2><a class="header" href="#database-structure" id="database-structure">Database Structure</a></h2>
<p>Before we can define a new query, we need to understand the database structure. The database schema is defined in two files:</p>
<ol>
<li><code>database/src/schema.dl</code> – core data, which is generated by the extractor. Modifications made to this file require rerunning the extractor.</li>
<li><code>database/src/derived.dl</code> – derived data, or, in other words, data computed by the queries and stored in the database so that it can be reused by other queries.</li>
</ol>
<p>From these schemas, the procedural macros generate various data structures and functions. For writing queries, the most important data structure is <a href="https://rust-corpus.github.io/qrates/doc/corpus_database/tables/struct.Loader.html">Loader</a> that allows loading the relations stored in the database as Rust vectors. <code>&amp;Loader</code> is passed as an argument to each query.</p>
<p>One very important derived relation is <code>selected_builds</code> that is created from the <code>CrateList.json</code> the by query <code>prepare-builds</code>. Since we can have more than one build of the same crate (for example, if we had among dependencies different versions of a crate or the same crate with different configuration flags), to avoid duplicates in the analysis the <code>selected_builds</code> relation stores which builds should be analysed by queries.</p>
<p>For our query, we are interested in three relations:</p>
<ol>
<li><code>types_adt_field</code> – the relation between fields and their types.</li>
<li><code>types_raw_ptr</code> – the relation that contains all types that are raw pointers.</li>
<li><code>selected_adts</code> – the derived relation that contains the abstract data types such as <code>enum</code> or <code>struct</code> defined in <code>selected_builds</code>.</li>
</ol>
<h2><a class="header" href="#computing-the-relation" id="computing-the-relation">Computing the Relation</a></h2>
<p>For your query, create a new module in <code>manager/src/queries/mod.rs</code>. For example:</p>
<pre><code class="language-rust no_run noplayground">mod non_tree_types;
</code></pre>
<p>The module should contain the function <code>query</code>:</p>
<pre><code class="language-rust no_run noplayground">pub fn query(loader: &amp;Loader, report_path: &amp;Path) {
    // Query implementation.
}
</code></pre>
<p>Here, <code>loader</code> is the <code>Loader</code> object mentioned in the previous section and <code>report_path</code> is the folder in which we should store the CSV files.</p>
<p>Before we write the result to a CSV file, we will obtain a vector of types that contain raw pointer fields. We can do this via a simple Datalog query (we are using <a href="https://github.com/lqd/datapond">Datapond</a> library):</p>
<pre><code class="language-rust no_run noplayground">// Declare the output variable.
let non_tree_types;
datapond_query! {
    // Load the relations by using “loader”.
    load loader {
        relations(types_adt_field, types_raw_ptr),
    }
    // Specify that “non_tree_types” is the output variable.
    output non_tree_types(typ: Type)
    // Define the relation by using a Datalog rule:
    non_tree_types(adt) :-
        types_adt_field(.adt=adt, .typ=typ),
        types_raw_ptr(.typ=typ).
}
</code></pre>
<p>To generate the readable CSV file with the information, we need to traverse the list of all relevant adts, check for each of them whether it is one of the types from <code>non_tree_types</code> and if yes, desugar to a human readable format. To make the checking more efficient, we can convert <code>non_tree_types</code> from a vector to a hash set. The code would be:</p>
<pre><code class="language-rust no_run noplayground">let non_tree_types: HashSet&lt;_&gt; = non_tree_types.elements.iter().map(|&amp;(typ,)| typ).collect();
let non_tree_adts = selected_adts.iter().flat_map(
    |&amp;(
        build,
        item,
        typ,
        def_path,
        resolved_def_path,
        name,
        visibility,
        type_kind,
        def_kind,
        kind,
        c_repr,
        is_phantom,
    )| {
        if non_tree_types.contains(&amp;typ) {
            Some((
                build,
                build_resolver.resolve(build),
                item,
                typ,
                def_path_resolver.resolve(def_path),
                def_path_resolver.resolve(resolved_def_path),
                &amp;strings[name],
                visibility.to_string(),
                &amp;strings[type_kinds[type_kind]],
                def_kind.to_string(),
                kind.to_string(),
                c_repr,
                is_phantom,
            ))
        } else {
            None
        }
    },
);
</code></pre>
<p>Finally, we can write the results to the CSV file:</p>
<pre><code class="language-rust no_run noplayground">write_csv!(report_path, non_tree_adts);
</code></pre>
<p>The results will be written to a file <code>../workspace/reports/&lt;query-name&gt;/&lt;iterator-variable&gt;.csv</code>.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="queries_run_existing.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="analysis_jupyter.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="queries_run_existing.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="analysis_jupyter.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
